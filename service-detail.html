<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Service details - Student Sphere">
  <title>Service Details - Student Sphere</title>

  <!-- Bootstrap 5.3 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Bootstrap Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
  <!-- Custom CSS -->
  <link rel="stylesheet" href="css/style.css">
</head>
<body>
  <!-- Toast Container -->
  <div id="toastContainer" style="position: fixed; top: 20px; right: 20px; z-index: 9999;"></div>

  <!-- Navigation -->
  <nav class="navbar navbar-expand-lg navbar-dark navbar-custom sticky-top">
    <div class="container">
      <a class="navbar-brand fw-bold fs-4" href="index.html">
        <i class="bi bi-cash-coin"></i> Student Sphere
      </a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav ms-auto">
          <li class="nav-item">
            <a class="nav-link" href="browse.html">Browse</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="create-service.html">Post Service</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="profile.html">Profile</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="login.html">Login</a>
          </li>
          <li class="nav-item">
            <a class="btn btn-light btn-sm ms-2" href="signup.html">Sign Up</a>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <!-- Main Content -->
  <main class="py-5 bg-light">
    <div class="container">
      <div class="row g-4">
        <!-- Left Column - Service Details -->
        <div class="col-lg-8">
          <!-- Service Image -->
          <div class="card mb-4 border-0 shadow-sm">
            <div class="position-relative">
              <img id="serviceImage" src="" alt="Service" class="card-img-top" style="height: 400px; object-fit: cover;">
              <span id="categoryBadge" class="badge position-absolute top-0 start-0 m-3"></span>
            </div>
          </div>
          
          <!-- Service Info -->
          <div class="card border-0 shadow-sm mb-4">
            <div class="card-body p-4">
              <h1 class="fw-bold mb-3" id="serviceTitle"></h1>
              
              <div class="d-flex align-items-center text-muted mb-4">
                <i class="bi bi-geo-alt me-2"></i>
                <span id="serviceLocation"></span>
              </div>
              
              <p class="lead" id="serviceDescription"></p>
            </div>
          </div>
          
          <!-- Reviews Section -->
          <div class="card border-0 shadow-sm">
            <div class="card-body p-4">
              <h3 class="fw-bold mb-4">Reviews</h3>
              <div id="reviewsContainer">
                <!-- Reviews will be loaded here -->
              </div>
            </div>
          </div>
        </div>
        
        <!-- Right Column - Sidebar -->
        <div class="col-lg-4">
          <!-- Price & Contact Card -->
          <div class="card border-0 shadow-sm mb-4 sticky-top" style="top: 80px;">
            <div class="card-body p-4">
              <div class="price-display mb-4" id="servicePrice"></div>
              
              <!-- Payment Methods -->
              <div class="mb-4">
                <h6 class="fw-bold mb-3">Payment Methods</h6>
                <div id="paymentMethods" class="d-flex flex-wrap gap-2">
                  <!-- Payment methods will be loaded here -->
                </div>
              </div>
              
              <!-- WhatsApp Contact Button -->
              <button 
                class="btn btn-whatsapp w-100 btn-lg btn-hover mb-3" 
                id="whatsappButton"
                onclick="handleWhatsAppContact()">
                <i class="bi bi-whatsapp me-2"></i> Contact on WhatsApp
              </button>
            </div>
          </div>
          
          <!-- Seller Info Card -->
          <div class="card border-0 shadow-sm">
            <div class="card-body p-4">
              <h6 class="fw-bold mb-3">Seller Information</h6>
              
              <div class="d-flex align-items-center mb-3">
                <img id="sellerAvatar" src="" alt="Seller" class="rounded-circle me-3" width="48" height="48">
                <div class="flex-grow-1">
                  <div class="d-flex align-items-center">
                    <span class="fw-bold" id="sellerName"></span>
                    <i class="bi bi-patch-check-fill verified-badge ms-2" id="verifiedBadge" style="display: none;"></i>
                  </div>
                  <small class="text-muted" id="sellerUniversity"></small>
                </div>
              </div>
              
              <div class="border-top pt-3">
                <div class="d-flex justify-content-between mb-2">
                  <span class="text-muted">Rating</span>
                  <div>
                    <i class="bi bi-star-fill star-filled"></i>
                    <span class="fw-bold" id="sellerRating"></span>
                  </div>
                </div>
                <div class="d-flex justify-content-between">
                  <span class="text-muted">Member since</span>
                  <span id="memberSince"></span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- More Services -->
      <div class="mt-5">
        <h3 class="fw-bold mb-4">More Services</h3>
        <div id="moreServicesContainer"></div>
      </div>
    </div>
  </main>

  <!-- Footer -->
  <footer class="footer-custom py-5">
    <div class="container">
      <div class="row">
        <div class="col-md-4 mb-4 mb-md-0">
          <h5 class="fw-bold mb-3">
            <i class="bi bi-cash-coin"></i> Student Sphere
          </h5>
          <p class="text-white-50">Empowering South African students to monetize their skills and connect with their campus community.</p>
        </div>
        <div class="col-md-4 mb-4 mb-md-0">
          <h5 class="fw-bold mb-3">Quick Links</h5>
          <ul class="list-unstyled">
            <li><a href="browse.html" class="text-white-50 text-decoration-none">Browse Services</a></li>
            <li><a href="create-service.html" class="text-white-50 text-decoration-none">Post a Service</a></li>
            <li><a href="login.html" class="text-white-50 text-decoration-none">Login</a></li>
            <li><a href="signup.html" class="text-white-50 text-decoration-none">Sign Up</a></li>
          </ul>
        </div>
        <div class="col-md-4">
          <h5 class="fw-bold mb-3">Connect</h5>
          <div class="d-flex gap-3">
            <a href="#" class="text-white fs-4"><i class="bi bi-facebook"></i></a>
            <a href="#" class="text-white fs-4"><i class="bi bi-twitter"></i></a>
            <a href="#" class="text-white fs-4"><i class="bi bi-instagram"></i></a>
            <a href="#" class="text-white fs-4"><i class="bi bi-linkedin"></i></a>
          </div>
        </div>
      </div>
      <hr class="my-4 bg-white opacity-25">
      <div class="text-center text-white-50">
        <p class="mb-0">&copy; 2024 Student Sphere. All rights reserved.</p>
      </div>
    </div>
  </footer>

  <!-- Bootstrap 5.3 JS Bundle -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  
  <!-- Supabase JS Client -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="js/supabase-client.js"></script>

  <!-- Custom JavaScript -->
  <script src="js/data.js"></script>
  <script src="js/utils.js"></script>
  <script src="js/services.js"></script>
  <script src="js/auth.js"></script>
  
  <!-- Page-specific JavaScript -->
 <script>
  let currentService = null;

  // ðŸ§­ Get ID from URL (?id=...)
  function getUrlParameter(name) {
    const url = new URL(window.location.href);
    return url.searchParams.get(name);
  }

  // ðŸ§± Main loader
  async function loadServiceDetails() {
    const serviceId = getUrlParameter('id');

    if (!serviceId) {
      window.location.href = 'browse.html';
      return;
    }

    //  1ï¸âƒ£ Try demo data first
    const demoService = getServiceById(serviceId);

    //  2ï¸âƒ£ Fetch real service from Supabase
    const supabaseService = await fetchSupabaseService(serviceId);

    //  Decide what to show
    if (demoService && supabaseService) {
      console.log('âœ… Showing Supabase service (user-created)');
      currentService = supabaseService;
    } else if (supabaseService) {
      console.log('âœ… Showing Supabase service only');
      currentService = supabaseService;
    } else if (demoService) {
      console.log('âœ… Showing demo service only');
      currentService = demoService;
    } else {
      showToast('Service not found', 'error');
      setTimeout(() => (window.location.href = 'browse.html'), 1500);
      return;
    }

    renderServiceDetails(currentService);
  }

  //  Fetch service from Supabase
  async function fetchSupabaseService(serviceId) {
  const { data: service, error } = await supabase
    .from('services')
    .select('*')
    .eq('id', serviceId)
    .single();

  if (error || !service) {
    console.error('Service fetch error:', error);
    return null;
  }

  // Fetch seller profile
  const { data: profile, error: profileError } = await supabase
    .from('profiles')
    .select('full_name, avatar_url')
    .eq('id', service.user_id)
    .single();

  if (profileError) console.warn('Profile fetch error:', profileError);

  let initials = '';
  if (profile?.full_name) {
    const parts = profile.full_name.split(' ');
    initials = parts.map(p => p[0]).join('').toUpperCase();
  }

  return {
    id: service.id,
    title: service.title,
    description: service.description,
    category: service.category,
    location: service.location,
    price: service.price,
    imageUrl: service.image_url || 'assets/images/default-service.jpg',
    sellerAvatar: profile?.avatar_url
      ? profile.avatar_url
      : `https://ui-avatars.com/api/?name=${encodeURIComponent(profile?.full_name || initials)}&background=random`,
    sellerName: profile?.full_name || 'Anonymous Seller',
    sellerUniversity: service.university || 'Unknown University',
    paymentMethods: service.payment_methods || [],
    sellerPhone: service.phone || '',
    verified: false,
  };
}


  // Render service details
  function renderServiceDetails(service) {
    document.title = `${service.title} - Student Sphere`;

    document.getElementById('serviceImage').src = service.imageUrl;
    document.getElementById('serviceTitle').textContent = service.title;
    document.getElementById('serviceLocation').textContent = service.location;
    document.getElementById('serviceDescription').textContent = service.description;
    document.getElementById('servicePrice').textContent = formatPrice(service.price);
    document.getElementById('categoryBadge').textContent = capitalize(service.category || 'General');
    document.getElementById('categoryBadge').className = `badge ${getCategoryBadgeClass(service.category)} position-absolute top-0 start-0 m-3`;

    // Payment methods
    const paymentContainer = document.getElementById('paymentMethods');
    paymentContainer.innerHTML = service.paymentMethods.length
      ? service.paymentMethods.map((m) => `<span class="payment-badge">${getPaymentIcon(m)} ${m}</span>`).join('')
      : '<span class="text-muted">No payment methods listed</span>';

    // Seller info
    document.getElementById('sellerAvatar').src = service.sellerAvatar;
    document.getElementById('sellerName').textContent = service.sellerName;
    document.getElementById('sellerUniversity').textContent = service.sellerUniversity;
    document.getElementById('sellerRating').textContent = `${service.sellerRating}/5.0`;
    document.getElementById('memberSince').textContent = service.sellerMemberSince;

    if (service.verified) {
      document.getElementById('verifiedBadge').style.display = 'inline';
    } else {
      document.getElementById('verifiedBadge').style.display = 'none';
    }

    loadReviews();
  }

  //  Demo reviews
  function loadReviews() {
    const container = document.getElementById('reviewsContainer');
    if (!demoReviews || demoReviews.length === 0) {
      container.innerHTML = '<p class="text-muted">No reviews yet.</p>';
      return;
    }

    container.innerHTML = demoReviews
      .map(
        (r) => `
        <div class="mb-4 pb-4 border-bottom">
          <div class="d-flex align-items-start gap-3">
            <img src="${r.reviewerAvatar}" alt="${r.reviewerName}" class="rounded-circle" width="40" height="40">
            <div class="flex-grow-1">
              <div class="d-flex justify-content-between mb-2">
                <span class="fw-bold">${r.reviewerName}</span>
                <small class="text-muted">${r.date}</small>
              </div>
              <div class="mb-2">${renderStarRating(r.rating)}</div>
              <p class="mb-0">${r.comment}</p>
            </div>
          </div>
        </div>`
      )
      .join('');
  }

  //  WhatsApp Contact
  function handleWhatsAppContact() {
    if (currentService?.sellerPhone) {
      contactViaWhatsApp(currentService.sellerPhone, currentService.title);
    } else {
      showToast('Phone number not available', 'warning');
    }
  }

  // ðŸš€ Initialize
  document.addEventListener('DOMContentLoaded', () => {
    loadServiceDetails();
    updateNavbarAuth();
  });
</script>

</body>
</html>
